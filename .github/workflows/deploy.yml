name: Deploy Raffley to VPS
env:
  MIX_ENV: prod

# Required GitHub Secrets:
# - VPS_HOST: Hostname/IP of your VPS server
# - VPS_SSH_USER: SSH username for VPS access
# - VPS_SSH_PRIVATE_KEY: SSH private key for authentication
# - VPS_DEPLOY_PATH: Absolute path to deployment directory on VPS
# - SECRET_KEY_BASE: Phoenix secret key base
# - DATABASE_URL: Database connection string
# - RESEND_API_KEY: API key for Resend email service
# - PHX_HOST: Hostname for the application

on:
  push:
    branches: [main]

jobs:
  build:
    name: Build Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.18'
          otp-version: '27'

      - name: Cache Mix dependencies
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}

      - name: Compile project
        run: mix compile --force

      - name: Build release
        run: mix release --overwrite

      - name: Archive release artifact
        run: |
          RELEASE_NAME=$(ls _build/prod/rel/)
          tar -czf release.tar.gz -C _build/prod/rel/$RELEASE_NAME .

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: raffley-release
          path: release.tar.gz

  deploy:
    name: Deploy to VPS
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download release artifact
        uses: actions/download-artifact@v4
        with:
          name: raffley-release
          path: .

      # Debug step - verify SSH connectivity first
      - name: Verify SSH access
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          script: |
            echo "✅ SSH connection successful"
            echo "Current user: $(whoami)"
            echo "Home directory: $HOME"
            echo "Working directory: $(pwd)"
            echo "Environment variables:"
            printenv | sort
            echo "Checking write permission to ${{ secrets.VPS_DEPLOY_PATH }}"
            mkdir -p "${{ secrets.VPS_DEPLOY_PATH }}"
            touch "${{ secrets.VPS_DEPLOY_PATH }}/testfile" && \
              rm "${{ secrets.VPS_DEPLOY_PATH }}/testfile" && \
              echo "✅ Write permission verifi            echo "## PRE-DEPLOYMENT CHECKS ##"
            echo "1. Checking target directory permissions:"
            ls -ld "$DEPLOY_PATH" || echo "Directory doesn't exist"
            
            echo "2. Verifying write access:"
            if ! touch "$DEPLOY_PATH/.deploy_test" 2>/dev/null; then
              echo "❌ Cannot write to $DEPLOY_PATH"
              echo "Current permissions:"
              ls -ld "$DEPLOY_PATH"
              echo "Suggested fix (run on VPS):"
              echo "  sudo mkdir -p '$DEPLOY_PATH'"
              echo "  sudo chown -R $USER:$USER '$DEPLOY_PATH'"
              exit 1
            else
              rm "$DEPLOY_PATH/.deploy_test"
              echo "✅ Write access verified"
            fi
            
            echo "3. Checking sudo privileges:"
            if ! sudo -n true 2>/dev/null; then
              echo "❌ Passwordless sudo access required"
              echo "Run on VPS: sudo visudo"
              echo "Add line: $USER ALL=(ALL) NOPASSWD: ALL"
              exit 1
            fi
            echo "✅ Sudo access verified"

            echo "## SERVICE MANAGEMENT ##"
            echo "1. Checking current service status:"
            sudo systemctl status "$RELEASE_NAME.service" || true
            
            echo "2. Stopping service..."
            if ! sudo systemctl stop "$RELEASE_NAME.service"; then
              echo "⚠ Failed to stop service (may not exist yet)"
            fi
            echo "--- Cleaning Previous Deployment ---"
            [ -d "$RELEASE_DIR" ] && rm -rf $RELEASE_DIR/*
            [ -d "$RELEASE_DIR" ] && rm -rf $RELEASE_DIR/*
            mkdir -p "$RELEASE_DIR"

            echo "--- Deploying New Release ---"
            mv "$RELEASE_TAR" "$DEPLOY_PATH/"
            tar -xzf "$DEPLOY_PATH/$RELEASE_TAR" -C "$RELEASE_DIR"
            rm "$DEPLOY_PATH/$RELEASE_TAR"
            
            echo "🔐 Setting proper permissions..."
            find "$RELEASE_DIR" -type d -exec chmod 755 {} \;
            find "$RELEASE_DIR" -type f -exec chmod 644 {} \;
            chmod +x "$RELEASE_DIR/bin/$RELEASE_NAME"
            echo "--- Running Database Migrations ---"
            $RELEASE_DIR/bin/$RELEASE_NAME eval "Raffley.Release.migrate"

            echo "--- Starting Service ---"
            sudo systemctl start $RELEASE_NAME.service

            echo "--- Verifying Deployment ---"
            sleep 5
            systemctl is-active --quiet $RELEASE_NAME.service || \
              (echo "Service failed to start"; exit 1)
            echo "Deployment successful!"

            # Remote health check (optional)
            # curl -sSf http://localhost:4000/health >/dev/null || \
            #   (echo "Health check failed"; exit 1)

      - name: Notify Success
        if: success()
        run: echo "Deployment completed successfully"
        # Could add Slack/Email notification here

      - name: Notify Failure
        if: failure()
        run: echo "Deployment failed"
        # Could add error notification here
